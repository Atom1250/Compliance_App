name: Codex Run Prompt (Create PR)

on:
  workflow_dispatch:
    inputs:
      prompt_file:
        description: "Path to prompt file in repo (e.g. .github/codex/prompts/pr-001.md)"
        required: true
        default: ".github/codex/prompts/pr-001.md"
      pr_branch:
        description: "Branch name to create/update (e.g. codex/pr-001)"
        required: true
        default: "codex/pr-001"
      pr_title:
        description: "Pull request title"
        required: true
        default: "Codex: PR-001 Tooling + CI"
      pr_body:
        description: "Pull request body (optional)"
        required: false
        default: "Automated changes generated by Codex using the provided prompt file."

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-run-prompt
  cancel-in-progress: false

jobs:
  codex_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create / switch to branch
        run: |
          git checkout -B "${{ inputs.pr_branch }}"

      - name: Run Codex on prompt file
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: ${{ inputs.prompt_file }}
          # Optional: if you want more autonomy, the action supports passing codex CLI args.
          # Many examples use workspace-write sandboxes and full-auto modes.
          # If your action version supports these inputs, uncomment and tune:
          # sandbox: workspace-write
          # codex-args: '["--full-auto"]'

      - name: Show Codex output in logs
        run: |
          echo "===== Codex output ====="
          echo "${{ steps.codex.outputs.final_message }}"

      - name: Configure git identity
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"

      - name: Commit changes (if any)
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "codex: apply ${{ inputs.prompt_file }}"

      - name: Push branch
        run: |
          git push --force --set-upstream origin "${{ inputs.pr_branch }}"

      - name: Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = "${{ inputs.pr_branch }}";
            const base = "main";
            const title = "${{ inputs.pr_title }}";
            const body = "${{ inputs.pr_body }}";

            // Find existing PR from head->base
            const prs = await github.rest.pulls.list({
              owner, repo, state: "open", head: `${owner}:${head}`, base
            });

            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.pulls.update({ owner, repo, pull_number: pr.number, title, body });
              core.info(`Updated existing PR #${pr.number}`);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body });
              core.info(`Created PR #${pr.data.number}`);
            }

