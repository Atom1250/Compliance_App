name: Codex Run Prompt (Create PR)

on:
  workflow_dispatch:
    inputs:
      prompt_file:
        description: "Path to prompt file in repo"
        required: true
        default: ".github/codex/prompts/meta_next_pr.md"
      pr_branch:
        description: "Branch name to create/update"
        required: true
        default: "codex/auto-next"
      pr_title:
        description: "Pull request title"
        required: true
        default: "Codex: Auto Next PR"
      pr_body:
        description: "Pull request body (optional)"
        required: false
        default: "Automated changes generated by Codex using the provided prompt file."

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-run-prompt
  cancel-in-progress: false

jobs:
  codex_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or switch to branch
        run: |
          git checkout -B "${{ inputs.pr_branch }}"

      - name: Prepare Codex home
        run: |
          mkdir -p "${{ runner.temp }}/codex-home"

      - name: Verify OPENAI_API_KEY is present
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY secret is missing/empty for this run."
            exit 1
          fi

      - name: Run Codex on prompt file
        id: codex
        uses: openai/codex-action@v1.3
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          codex-version: "0.58.0"
          prompt-file: ${{ inputs.prompt_file }}
          codex-home: ${{ runner.temp }}/codex-home

      - name: Configure git identity
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"

      - name: Commit changes (if any)
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "codex: apply ${{ inputs.prompt_file }}"

      - name: Push branch
        run: |
          git push --force --set-upstream origin "${{ inputs.pr_branch }}"

      - name: Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = "${{ inputs.pr_branch }}";
            const base = "main";
            const title = "${{ inputs.pr_title }}";
            const body = "${{ inputs.pr_body }}";

            const prs = await github.rest.pulls.list({
              owner, repo, state: "open", head: `${owner}:${head}`, base
            });

            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.pulls.update({ owner, repo, pull_number: pr.number, title, body });
              core.info(`Updated existing PR #${pr.number}`);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body });
              core.info(`Created PR #${pr.data.number}`);
            }
