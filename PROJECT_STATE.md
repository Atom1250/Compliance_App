# Project State — Regulatory Registry + Obligations Conveyor

Next PR ID: PR-NBLM-011

## Completed Work
- Run hardening increment completed (post triage for Iberdrola 2025 runs 60-65).
- Added fail-closed terminal status handling in execution/readiness paths with quality-gate integration (`completed_with_warnings`, `degraded_no_evidence`, `failed_pipeline`).
- Added retrieval smoke test event + optional automatic filter relaxation gate (`COMPLIANCE_APP_RETRIEVAL_SMOKE_AUTO_RELAX_FILTERS`) and persisted smoke diagnostics in run retrieval params.
- Added run observability inventory endpoint `GET /runs/{run_id}/manifest-truth` combining discovery candidates, selected docs, ingest metrics, chunk/index status, and retrieval smoke payload.
- Updated UAT harness + fixtures/golden snapshot for expanded terminal statuses.
- PR-NBLM-007..PR-NBLM-010 completed (NotebookLM infra, workflow API, CI stub safety, ops runbooks).
- Added NotebookLM sidecar compose file `docker/compose.notebooklm.yml` plus local setup/manual integration runbooks.
- Added internal regulatory research endpoints and CLI (`/internal/regulatory-research/*`, `python -m apps.api.app.scripts.regulatory_research_query`).
- Added deterministic stub provider factory path for CI/offline runs and new API/provider contract tests.
- Added operational runbooks for auth governance, monitoring, breakage response, and data-governance controls.
- PR-NBLM-006 completed (NotebookLM MCP provider integration).
- Added NotebookLM integration modules in `apps/api/app/integrations/notebooklm/` (`mcp_client`, `provider`, `parser`, typed errors).
- Added MCP config fields and defaults for base URL, notebook map JSON, timeout, and retries.
- Added parser/provider/client contract tests (`tests/test_notebooklm_parser.py`, `tests/test_notebooklm_provider.py`, `tests/test_notebooklm_mcp_client.py`).
- Updated docs and env examples for NotebookLM MCP runtime settings.
- PR-NBLM-000..PR-NBLM-005 completed (NotebookLM MCP regulatory research service foundation).
- Added ADR `docs/adr/0003-notebooklm-regulatory-research-service.md` formalizing workflow-only usage, kill-switch controls, and breakage response plan.
- Added feature-flagged research service modules under `apps/api/app/services/regulatory_research/` (types, provider interface, deterministic request hashing, orchestrator, citation validation).
- Added Postgres-backed audit persistence with migrations `0024_regulatory_research_cache` and `0025_regulatory_requirement_research_notes`, plus repository helpers for cache and notes.
- Added/updated tests (`tests/test_regulatory_research_hash.py`, `tests/test_regulatory_research_citations.py`, `tests/test_regulatory_research_service.py`) and docs (`README.md`, `docs/regulatory_research_service.md`, `.example.env`) for CSV-safe defaults and flag behavior.
- PR-001 completed (Phase 0 bootstrap + baseline lock).
- Verified mandatory conveyor artifacts exist: `PROJECT_STATE.md`, `docs/PR_CONVEYOR_PLAN.md`, `.github/pull_request_template.md`, `.github/codex/prompts/meta_next_pr.md`.
- Verified ADR-0001 path exists and is readable at `docs/adr/0001-architecture.md`.
- Added legacy regression guardrail test: `tests/test_legacy_requirements_resolution_stability.py`.
- Added PR execution log: `docs/prs/PR-001.md`.
- PR-002 completed (A1 Part 1: schema + canonicalization).
- Added `app/regulatory/schema.py` with minimal validated bundle models (`RegulatoryBundle`, `Obligation`, `Element`, `PhaseInRule`).
- Added `app/regulatory/canonical.py` with deterministic canonical JSON and SHA-256 checksum helpers.
- Added unit tests in `tests/test_regulatory_schema_and_canonical.py` for schema acceptance/rejection and checksum stability/change sensitivity.
- Added PR execution log: `docs/prs/PR-002.md`.
- PR-003 completed (A1 Part 2: loader + sample bundle).
- Added sample fixture bundle `app/regulatory/bundles/eu_csrd_sample.json` for registry/compiler test scaffolding.
- Added `app/regulatory/loader.py` to load + validate + return `(bundle, checksum, source_path)` deterministically.
- Added loader tests in `tests/test_regulatory_loader.py` covering deterministic checksum/path behavior and invalid payload rejection.
- Added PR execution log: `docs/prs/PR-003.md`.
- PR-004 completed (A2 Part 1: DB model + migration for regulatory bundles).
- Added ORM model `RegulatoryBundle` with `bundle_id`, `version`, `jurisdiction`, `regime`, `checksum`, and JSON `payload`.
- Added Alembic migration `0013_regulatory_bundle_table.py` to create/drop `regulatory_bundle` table and indexes.
- Extended migration tests to include regulatory table presence and explicit upgrade/downgrade smoke path.
- Added PR execution log: `docs/prs/PR-004.md`.
- PR-005 completed (A2 Part 2: registry store operations).
- Added `apps/api/app/services/regulatory_registry.py` with deterministic `upsert_bundle()` and `get_bundle()` operations.
- Implemented checksum-based idempotency/update behavior keyed by `bundle_id` + `version`.
- Added registry tests in `tests/test_regulatory_registry.py` for idempotent upsert, retrieval, and changed-payload checksum update.
- Added PR execution log: `docs/prs/PR-005.md`.
- PR-006 completed (A2 Part 3: filesystem sync).
- Added deterministic registry sync function `sync_from_filesystem()` to import all bundle JSON files from a root directory.
- Ensured deterministic processing order and idempotent behavior through sorted file traversal and upsert semantics.
- Added tests in `tests/test_regulatory_registry_sync.py` for repeatable sync outputs and stable ordering.
- Added PR execution log: `docs/prs/PR-006.md`.
- PR-007 completed (A2 Part 4: flagged startup sync hook).
- Added runtime config flags: `regulatory_registry_sync_enabled` and `regulatory_registry_bundles_root`.
- Added FastAPI startup hook that runs registry sync only when explicitly enabled.
- Added tests in `tests/test_regulatory_sync_startup.py` verifying the hook is off by default and executes when enabled.
- Added PR execution log: `docs/prs/PR-007.md`.
- PR-008 completed (A3 Part 1: safe evaluator context extension).
- Added `app/regulatory/safe_eval.py` with strict AST sandboxing for structured context expressions.
- Added explicit symbol whitelist enforcement and unknown symbol/attribute rejection behavior.
- Added tests in `tests/test_regulatory_safe_eval.py` for positive evaluation and rejection paths.
- Added PR execution log: `docs/prs/PR-008.md`.
- PR-009 completed (A3 Part 2: compiler core + compiled plan schema).
- Added `app/regulatory/compiler.py` with deterministic bundle compilation to applicable obligations/elements.
- Added compiled plan schema models and stable ordering for obligations/elements.
- Added phase-in rule handling through strict safe-eval evaluation.
- Added tests in `tests/test_regulatory_compiler.py` for deterministic ordering and phase-in behavior.
- Added PR execution log: `docs/prs/PR-009.md`.
- PR-010 completed (A3 Part 3: compile-from-DB adapter).
- Added `compile_from_db()` in `apps/api/app/services/regulatory_registry.py` to load stored payloads and compile plans.
- Added integration tests in `tests/test_regulatory_compile_from_db.py` covering sync->compile flow and missing-bundle failure.
- Preserved deterministic compile behavior by reusing schema validation + compiler ordering logic.
- Added PR execution log: `docs/prs/PR-010.md`.
- PR-011 completed (A4: CLI inspect/sync/preview interface).
- Added CLI helpers in `app/regulatory/cli.py` for listing bundles, filesystem sync, and compile preview from DB.
- Added `app/regulatory/__main__.py` entrypoint exposing `list`, `sync`, and `compile-preview` commands.
- Added tests in `tests/test_regulatory_cli.py` for sync/list/preview behavior and safe context JSON parsing.
- Added PR execution log: `docs/prs/PR-011.md`.
- PR-012 completed (B1: requirements extension + bundle-view adapter).
- Extended `app/requirements/schema.py` with optional obligations support while preserving legacy datapoint contracts.
- Added `app/requirements/bundle_view.py` with deterministic adapters for legacy datapoints and flattened obligation elements.
- Added back-compat tests in `tests/test_requirements_bundle_view.py` covering legacy bundle stability and obligations-native views.
- Added PR execution log: `docs/prs/PR-012.md`.
- PR-013 completed (B2 Part 1: company jurisdictions + compiler mode defaults).
- Added company fields `regulatory_jurisdictions` and `regulatory_regimes` with safe default `[]`.
- Added run field `compiler_mode` with default `legacy`.
- Added migration `0014_company_jurisdictions_and_run_compiler_mode.py`.
- Added persistence tests in `tests/test_regulatory_mode_defaults.py` validating defaults.
- Added PR execution log: `docs/prs/PR-013.md`.
- PR-014 completed (B2 Part 2: flagged registry datapoint generation).
- Added feature flag `feature_registry_compiler` (default OFF) in runtime config.
- Added deterministic generator `app/regulatory/datapoint_generation.py` for stable datapoint keys from compiled obligations.
- Added flagged registry branch in assessment pipeline P06 stage using `compile_from_db()` -> generated datapoints.
- Added tests in `tests/test_registry_mode_datapoints.py` for enabled registry mode and legacy-path behavior when flag is OFF.
- Added PR execution log: `docs/prs/PR-014.md`.
- PR-015 completed (B3 Part 1: manifest registry section + run-hash inputs).
- Extended run-hash inputs with `compiler_mode` and `registry_checksums` to avoid collisions across legacy/registry modes.
- Added registry manifest section (`retrieval_params.registry`) in registry mode, including bundle checksums.
- Updated execute-path tests for manifest payload and added registry-mode manifest coverage.
- Added PR execution log: `docs/prs/PR-015.md`.
- PR-016 completed (B3 Part 2: regulatory sync/compile audit events).
- Added `regulatory.sync.started|completed|failed` structured events in filesystem sync flow.
- Added `regulatory.compile.started|completed|failed` structured events in compile-from-DB flow.
- Added audit event tests in `tests/test_regulatory_audit_events.py`.
- Added PR execution log: `docs/prs/PR-016.md`.
- PR-017 completed (B4 Part 1: deterministic coverage matrix + flagged report section).
- Added deterministic registry coverage matrix computation in reporting service with stable obligation ordering.
- Added report matrix section gated by `feature_registry_report_matrix` (default OFF) and wired router rendering through runtime settings.
- Added tests in `tests/test_reporting.py` and `tests/test_registry_report_matrix_api.py` for deterministic computation and conditional rendering behavior.
- Added PR execution log: `docs/prs/PR-017.md`.
- PR-018 completed (B4 Part 2: evidence pack includes registry artifacts).
- Added registry-mode evidence pack artifacts: `registry/compiled_plan.json` and `registry/coverage_matrix.json`.
- Compiled plan artifact is generated from DB registry bundle + run company context and checksum-stamped in payload.
- Added tests in `tests/test_evidence_pack.py` to verify registry artifact inclusion and deterministic coverage matrix contents.
- Added PR execution log: `docs/prs/PR-018.md`.
- PR-019 completed (B5: seeded bundles + sync/compile end-to-end determinism tests).
- Added seeded minimal bundles for EU/UK/NO and green finance under `app/regulatory/bundles/`.
- Added end-to-end determinism test in `tests/test_regulatory_registry_end_to_end.py` covering filesystem sync idempotency and repeated compile stability.
- Verified seeded bundles compile with deterministic ordering and non-empty obligations for a stable company context.
- Added PR execution log: `docs/prs/PR-019.md`.
- PR-020 completed (B6: persisted run-scoped registry artifacts for deterministic exports).
- Added migration `0015_run_registry_artifact` and ORM model `RunRegistryArtifact`.
- Registry-mode run execution now persists compiled plan + coverage matrix as run-scoped artifacts.
- Evidence pack now reads registry artifacts from run-scoped storage (no compile-time dependency on current registry bundle rows).
- Added/updated tests in `tests/test_run_execute_api.py`, `tests/test_evidence_pack.py`, and `tests/test_db_migrations.py`; execution log added at `docs/prs/PR-020.md`.
- PR-021 completed (C1: deterministic run diagnostics API).
- Added `GET /runs/{run_id}/diagnostics` with deterministic metrics for manifest presence, required datapoints, assessment status counts, retrieval hit count, and stage outcomes.
- Added latest failure-reason extraction from `run.execution.failed` events for failure triage.
- Added tests in `tests/test_run_diagnostics_api.py` for completed run diagnostics, failed run diagnostics, and tenant scoping.
- Added PR execution log: `docs/prs/PR-021.md`.
- PR-022 completed (C2: discovery hardening).
- Added deterministic Tavily candidate tie-break ordering and explicit PDF-candidate URL checks.
- Added persistent storage of discovery candidate decisions with reasons via `document_discovery_candidate` table (migration `0016_document_discovery_candidate`).
- Updated auto-discover API to persist accepted/rejected decisions (`ingested`, `duplicate_ingested`, `non_pdf_candidate`, `max_documents_reached`, and exception reasons).
- Added/updated tests in `tests/test_tavily_discovery.py`, `tests/test_document_auto_discover_api.py`, and `tests/test_db_migrations.py`; execution log added at `docs/prs/PR-022.md`.
- PR-023 completed (C3: ingestion contract stabilization).
- Updated `/documents/upload` required-field validation to return a normalized 422 contract payload (`invalid_upload_request`) for missing metadata.
- Added title normalization (`strip`) before document persistence.
- Added integration tests in `tests/test_document_upload_integration.py` for consistent 422 behavior and normalized successful upload persistence.
- Added PR execution log: `docs/prs/PR-023.md`.
- PR-024 completed (C4: parser + chunk determinism golden tests).
- Added golden snapshot fixture `tests/golden/chunking_parser_snapshot.json` for chunk IDs/offsets and parser-version expectations.
- Added tests in `tests/test_chunking_golden.py` covering golden chunk snapshot matching, persisted chunk stability across rebuilds, and parser-version pin checks for PDF/DOCX/fallback paths.
- Verified deterministic chunking and extraction contracts remain stable under repeated execution.
- Added PR execution log: `docs/prs/PR-024.md`.
- PR-025 completed (C5: retrieval explainability artifacts).
- Added deterministic retrieval trace persistence (`retrieval_trace`) in run-scoped artifacts with per-datapoint candidate list, selected chunk IDs, and retrieval scores.
- Retrieval trace payload now includes retrieval policy metadata with explicit tie-break (`chunk_id`).
- Added/updated tests in `tests/test_assessment_pipeline.py` and `tests/test_run_execute_api.py` for artifact existence and stability.
- Added PR execution log: `docs/prs/PR-025.md`.
- PR-026 completed (C6: LLM provider adapter normalization).
- Added explicit supported-provider validation and local/cloud provider config guardrails in `llm_provider`.
- Extended extraction parsing to support both `/responses` and native `/chat/completions` payload shapes.
- Added normalized extraction error taxonomy (`llm_provider_error`, `llm_schema_parse_error`, `llm_schema_validation_error`) for clearer failure diagnostics.
- Added/updated tests in `tests/test_llm_provider.py` and `tests/test_llm_extraction.py`; execution log added at `docs/prs/PR-026.md`.
- PR-027 completed (C7: multi-provider LLM health endpoint).
- Added `/llm-health-matrix` endpoint returning deterministic health rows for `local_lm_studio` and `openai_cloud`.
- Added detailed probe helper returning reachability + parse status for provider responses.
- Added missing-cloud-key handling in matrix probe output (`missing_api_key`) without breaking existing single-provider endpoint behavior.
- Added/updated tests in `tests/test_llm_health_service.py` and `tests/test_llm_health_endpoint.py`; execution log added at `docs/prs/PR-027.md`.
- PR-028 completed (C8: ruleset version routing with pre-2026 support).
- Added deterministic routing helper `app/requirements/routing.py` for bundle/version resolution using reporting year/range.
- Wired routing into `/runs/{run_id}/execute` and `/runs/{run_id}/required-datapoints` while preserving explicit bundle/version overrides.
- Added tests in `tests/test_bundle_routing.py` and `tests/test_materiality.py` for pre-2026 routing, post-2026 routing, and explicit override behavior.
- Added PR execution log: `docs/prs/PR-028.md`.
- PR-029 completed (C9: run input snapshot freezing).
- Added migration `0017_run_input_snapshot` and ORM model `RunInputSnapshot` for immutable run input freezing.
- Added snapshot service `apps/api/app/services/run_input_snapshot.py` with canonical payload checksum persistence semantics.
- Run execution now persists a snapshot including company/materiality/retrieval settings and resolved datapoint universe prior to pipeline execution.
- Added/updated tests in `tests/test_run_execute_api.py` and `tests/test_db_migrations.py`; execution log added at `docs/prs/PR-029.md`.
- PR-030 completed (C10: failure taxonomy + retry policy).
- Added deterministic failure taxonomy in run worker (`provider_transient`, `bundle_not_found`, `config_error`, schema errors, etc.) with retryability flags.
- Extended `run.execution.failed` event payload/logging with `failure_category` and `retryable`.
- Added retry gating in execute API so `retry_failed=true` only requeues retryable failures; non-retryable cases emit `run.execution.retry.skipped`.
- Added/updated tests in `tests/test_run_execute_api.py`; execution log added at `docs/prs/PR-030.md`.
- PR-031 completed (D1: report data model refactor).
- Added typed report DTOs in `apps/api/app/services/reporting.py` and refactored HTML rendering to use typed data.
- Coverage denominator semantics now explicitly exclude `NA` datapoints and report excluded count.
- Added/updated report tests in `tests/test_reporting.py` and refreshed deterministic golden snapshots (`tests/golden/golden_run_snapshot.json`, `tests/golden/uat_harness_snapshot.json`).
- Added PR execution log: `docs/prs/PR-031.md`.
- PR-032 completed (D2: report preview API).
- Added API coverage for `GET /runs/{run_id}/report-preview` validating rendered HTML plus structured preview sections (`summary`, `metrics`, `gaps`, `rows`).
- Added tenant-scoping and completed-run guardrail tests for report preview endpoint behavior.
- Added tests in `tests/test_report_preview_api.py`.
- Added PR execution log: `docs/prs/PR-032.md`.
- PR-033 completed (D3: evidence pack preview API).
- Extended `GET /runs/{run_id}/evidence-pack-preview` contract with deterministic `pack_files` path/checksum metadata.
- Added preview validation that ZIP entries and manifest file list match, with checksum verification for each previewed artifact.
- Added/updated tests in `tests/test_evidence_pack_api.py` validating preview metadata and preview-to-ZIP manifest consistency.
- Added PR execution log: `docs/prs/PR-033.md`.
- PR-034 completed (D4: UI step-state hardening).
- Added explicit UI transition helper (`apps/web/lib/flow-state.ts`) with allowed stage transitions and state labels.
- Applied step-state transitions and clearer API-error messaging in run setup pages (`company`, `upload`, `run-config`, `run-status`, `report`).
- Added frontend transition coverage in `tests/test_web_ui_step_state.py` and aligned web API types with evidence preview checksum payload (`pack_files`).
- Added PR execution log: `docs/prs/PR-034.md`.
- PR-035 completed (D5: UI discovery→ingestion→run orchestration).
- Added guided client orchestration helper in `apps/web/lib/api-client.ts` to execute deterministic stages: discovery then run configuration/execution.
- Updated upload flow with `Auto-Find + Start Run`, deterministic stage updates, and automatic navigation to run status on success.
- Added API integration coverage in `tests/test_guided_flow_api_integration.py` and updated frontend contract tests (`tests/test_web_ui_scaffold.py`, `tests/test_web_ui_step_state.py`).
- Added PR execution log: `docs/prs/PR-035.md`.
- PR-036 completed (E1: evidence-gating enforcement audit pass).
- Added centralized evidence-gating enforcement in `apps/api/app/services/verification.py`.
- `Present/Partial` assessments without `evidence_chunk_ids` now downgrade to `Absent` with explicit rationale annotation.
- Added downgrade-path tests in `tests/test_verification.py` covering `Present` and `Partial` missing-evidence cases.
- Added PR execution log: `docs/prs/PR-036.md`.
- PR-037 completed (E2: export lifecycle contract hardening).
- Added deterministic export readiness endpoint `GET /runs/{run_id}/export-readiness` with explicit readiness checks and blocking reasons.
- Standardized report/evidence lifecycle gating with shared readiness logic, preserving 404 tenant scoping and predictable 409 not-ready contract semantics.
- Added lifecycle integration tests in `tests/test_export_lifecycle_api.py` and updated report lifecycle fixtures to satisfy manifest readiness checks.
- Added PR execution log: `docs/prs/PR-037.md`.
- PR-038 completed (E3: security and secrets baseline).
- Added startup provider validation selector `startup_validate_providers` (env: `COMPLIANCE_APP_STARTUP_VALIDATE_PROVIDERS`) for fail-fast runtime checks.
- Added provider-specific required-config validation for `local_lm_studio`, `openai_cloud`, and `tavily` in runtime configuration validation.
- Hardened sensitive log-field redaction for mixed-case and hyphenated key variants (for example `Authorization`, `X-Api-Key`, `openaiApiKey`).
- Added/updated tests in `tests/test_auth_config_validation.py` and `tests/test_audit_trail.py`; execution log added at `docs/prs/PR-038.md`.
- PR-039 completed (E4: CI determinism gates expansion).
- Expanded CI with a dedicated `determinism-gates` job for chunking, retrieval ordering, run hash, report/export, and UAT determinism checks.
- Expanded CI workflow validation with explicit migration smoke coverage (`tests/test_db_migrations.py`) and workflow YAML syntax parsing.
- Updated workflow hardening tests in `tests/test_workflow_hardening.py` to enforce presence of new CI deterministic/migration/workflow gates.
- Added PR execution log: `docs/prs/PR-039.md`.
- PR-040 completed (E5: UAT harness and golden scenario pack).
- Added versioned UAT scenario fixture pack (`tests/fixtures/uat/scenarios.json`) covering deterministic local-success and cloud-config-failure contracts.
- Extended `src/compliance_app/uat_harness.py` to execute scenario pack runs and validate readiness/report/evidence contract outcomes per scenario.
- Added operator runbook (`docs/runbooks/uat_execution.md`) and updated UAT golden snapshot (`tests/golden/uat_harness_snapshot.json`).
- Added PR execution log: `docs/prs/PR-040.md`.
- PR-041 completed (F1: persistence architecture lock).
- Added persistence cutover ADR `docs/adr/0002-persistence-cutover-postgres-pgvector.md` aligning runtime storage policy with ADR-0001.
- Formalized transitional policy: SQLite restricted to test/transitional workflows while Postgres+pgvector is system-of-record target.
- Added ADR contract guard test `tests/test_persistence_cutover_adr.py` and extended conveyor roadmap with PR-041/PR-042 sections.
- Added PR execution log: `docs/prs/PR-041.md`.
- PR-042 completed (F2: local Postgres/pgvector + MinIO provisioning baseline).
- Hardened `docker-compose.yml` with pgvector-ready Postgres image, init-script mount, and MinIO health checks.
- Added Postgres extension bootstrap script `docker/postgres/init/001-enable-pgvector.sql`.
- Added Make infrastructure targets `compose-up`, `compose-down`, and `db-wait`.
- Added infra contract tests (`tests/test_infra_compose_contract.py`) and local infra runbook (`docs/runbooks/local_infra_postgres_pgvector.md`); PR log at `docs/prs/PR-042.md`.
- PR-043 completed (F3: Postgres-first local defaults).
- Updated `.example.env` and `Makefile` development defaults to local Postgres DSN.
- Updated README run instructions to Postgres-first flow with explicit SQLite override for transitional local runs.
- Added defaults contract tests in `tests/test_dev_defaults_postgres.py`.
- Added PR execution log: `docs/prs/PR-043.md`.
- PR-044 completed (F4: Postgres migration smoke gates).
- Added Postgres migration smoke test `tests/test_db_migrations_postgres.py` covering Alembic upgrade/downgrade/upgrade and pgvector extension presence.
- Added CI `postgres-migration-smoke` job in `.github/workflows/ci.yml` using pgvector Postgres service and explicit Postgres test URL env.
- Updated workflow hardening invariants in `tests/test_workflow_hardening.py` for new Postgres migration gate.
- Added PR execution log: `docs/prs/PR-044.md`.
- PR-045 completed (F5: pgvector embedding schema activation).
- Added migration `0018_embedding_vector_column.py` with Postgres `vector` column path and SQLite compatibility fallback.
- Updated retrieval service to prefer `embedding_vector` payloads when available while preserving deterministic tie-break ordering.
- Added/updated tests in `tests/test_hybrid_retrieval.py`, `tests/test_db_migrations.py`, and `tests/test_db_migrations_postgres.py`; execution log added at `docs/prs/PR-045.md`.
- PR-046 completed (F6: Postgres end-to-end harness).
- Added Postgres harness module `src/compliance_app/postgres_e2e.py` for deterministic company->upload->run->manifest/export flow checks.
- Added CLI script `scripts/run_postgres_e2e.py` to run harness manually against a provided Postgres URL.
- Added gated integration test `tests/test_postgres_e2e_harness.py` validating manifest/readiness/report/evidence contracts on Postgres; execution log added at `docs/prs/PR-046.md`.
- PR-047 completed (F7: SQLite to Postgres migration tooling).
- Added migration utility `src/compliance_app/sqlite_to_postgres.py` for deterministic transfer of core tables with stable hash verification.
- Added CLI script `scripts/migrate_sqlite_to_postgres.py` emitting structured migration report output.
- Added idempotency test coverage in `tests/test_sqlite_to_postgres_migration.py`; execution log added at `docs/prs/PR-047.md`.
- PR-048 completed (F8: dual-backend determinism parity checks).
- Added parity harness utilities in `src/compliance_app/backend_parity.py` with normalization for backend-specific artifact shapes.
- Added regression tests in `tests/test_backend_parity.py` for normalization behavior and Postgres-gated SQLite-vs-Postgres parity.
- Extended Postgres E2E summary metadata in `src/compliance_app/postgres_e2e.py`; execution log added at `docs/prs/PR-048.md`.
- PR-049 completed (F9: Postgres SoR runtime cutover).
- Added runtime settings `runtime_environment` and `allow_sqlite_transitional` to enforce Postgres-first policy outside test mode.
- Updated runtime validation in `apps/api/app/core/ops.py` to reject SQLite unless test mode or explicit transitional override is enabled.
- Added enforcement tests in `tests/test_postgres_sor_enforcement.py` and test-suite SQLite guard in `tests/conftest.py`; execution log added at `docs/prs/PR-049.md`.
- PR-050 completed (F10: SQLite phase-down and final validation).
- Updated Postgres-first operator docs and added `docs/runbooks/postgres_cutover_validation.md` checklist.
- Added transition guard tests in `tests/test_postgres_phase_down_docs.py`.
- Fixed Postgres migration/runtime blockers discovered during live E2E validation (Alembic revision ID length constraints and `chunk.content_tsv` type compatibility) via migration chain updates and `0019_chunk_content_tsv_text.py`; execution log added at `docs/prs/PR-050.md`.
- PR-051..PR-061 completed as a consolidated gold-standard upgrade stream.
- Added gold-standard report contract artifact `docs/GOLD_STANDARD_REPORT_TEMPLATE_v1.md` and mapped PR conveyor sections `PR-051` through `PR-061`.
- Added manifest/report contract upgrades: `report_template_version` persisted in `run_manifest`, `REPORT_TEMPLATE_VERSION = "gold_standard_v1"`, and deterministic report section anchors aligned to template structure.
- Implemented discovery and ingestion hardening: year-range Tavily multi-query merge/dedupe, fetch-time PDF validation with retries/headers, larger default document-size cap, and cross-company duplicate document linking via `company_document_link`.
- Implemented retrieval and observability upgrades: company-scoped retrieval support, discovery diagnostics fields, UI diagnostics panel, benchmark harness script (`scripts/run_discovery_analysis_benchmark.py`), and supporting tests (`tests/test_company_document_link.py`, updated discovery/reporting/golden tests).
- PR-REG-001..PR-REG-008 completed (Regulatory Context Layer to Spec).
- Extended `regulatory_bundle` + `run_manifest` schema to persist regulatory compiler context (registry versions, compiler version, plan JSON/hash).
- Added deterministic company-context compiler service with jurisdiction/regime selection, overlay application, stable ordering, and canonical plan hash.
- Added minimal EU core bundle `csrd_esrs_core@2026.02` with ESRS E1-1/E1-6 and Norway overlay example, plus bundle sync CLI (`merge|sync`) and documentation.
- Wired run execution to persist compiler outputs into manifest and updated report metadata rendering to read manifest-backed regulatory values.
- Added read-only regulatory context APIs: `/regulatory/sources`, `/regulatory/bundles`, and `/runs/{run_id}/regulatory-plan`.
- PR-REG-009..PR-REG-014 completed (Regulatory Context Activation + Discovery/Verification Quality).
- Added relational persistence for regulatory execution context: `compiled_plan`, `compiled_obligation`, `obligation_coverage`, and `run_manifest.regulatory_plan_id`.
- Added deterministic document inventory classification/storage and API surface via `/documents/inventory/{company_id}`.
- Added extraction diagnostics persistence and stricter evidence/metric verification contracts with deterministic failure codes and downgrade semantics.
- Added orchestration guardrails for missing compiled obligations/chunks, plus diagnostics-threshold integrity warning events.
- Added PR execution logs: `docs/prs/PR-REG-009.md` through `docs/prs/PR-REG-014.md`.

## Tooling Notes
- Test command: `make test` (`.venv/bin/python -m pytest`)
- Lint command: `make lint` (`.venv/bin/python -m ruff check src apps tests`)
- Format command: no dedicated formatter target (ruff-only lint gate currently)
- Typecheck command: none configured
- Migration tooling: Alembic (`alembic.ini`, `alembic/versions/`, `alembic upgrade head`)
- Baseline PR-001 test run: `make test` -> `107 passed, 1 warning`

## Plan Gap Analysis (User PR-01..PR-06 vs Current State)
- PR-01 Registry Compiler Activation + Manifest Persistence:
- Partially complete. Registry compiler exists, runs during execution, and persists plan JSON/hash + compiler metadata in `run_manifest`.
- Missing from requested shape: dedicated `compiled_plan`/`compiled_obligation` relational tables and a hard run-fail when compiled obligations are zero for in-scope CSRD entities.
- PR-02 Document Universe & Inventory Engine:
- Partially complete. Deterministic Tavily discovery, dedupe, candidate persistence, and UI guided flow exist.
- Missing from requested shape: first-class document-universe inventory model with deterministic `doc_type` regex classification, `reporting_year`, and inventory-table-first UX independent from extraction.
- PR-03 Retrieval / Verification Contract Hardening:
- Partially complete. Evidence gating and downgrade logic are implemented.
- Missing from requested shape: persisted per-datapoint diagnostics contract (`retrieved_chunk_lengths`, `numeric_matches_found`, `failure_reason_code` taxonomy) and explicit regression fixture for orphan cited chunk IDs in extraction output contract checks.
- PR-04 Metric Datapoint Type System:
- Mostly missing. Current pipeline is status/value/citations-focused; no explicit `metric` datapoint type contract with baseline-required downgrade semantics.
- PR-05 ESRS Coverage Matrix Engine:
- Partially complete. Coverage matrix rendering exists for registry/reporting paths.
- Missing from requested shape: explicit obligation coverage persistence table and always-on obligation-level matrix rendering decoupled from extraction volume.
- PR-06 Run Orchestration Guardrails:
- Partially complete. Some lifecycle/readiness checks and failure taxonomy are implemented.
- Missing from requested shape: explicit pre-run guardrail contract (`compiled_plan missing`, `chunk table empty`, `diagnostics threshold -> integrity warning`) enforced as formal run orchestration gates.

## Open Risks / Unknowns
- [ ] Confirm migrations framework and how to run upgrade/downgrade in CI.
- [ ] Confirm existing auth pattern for admin endpoints (or decide CLI-only for PR-011).
- [ ] Confirm where feature flags/config lives and naming conventions.
- [ ] Confirm test DB strategy for expanded Postgres smoke and parity gates (env-provided URL vs compose service in CI).
- [ ] `pytest` warns on unknown config key `asyncio_default_fixture_loop_scope`; cleanup needed to avoid config drift.
- [ ] Postgres-gated tests currently require database-create privileges for full execution; when unavailable they skip by design.
- [ ] Discovery quality is still constrained by upstream source 403s; next phase should add deterministic alternate-source/mirror ranking and fallback fetch strategies.
- [ ] Discovery currently retrieves high-signal documents but not a full deterministic filing universe; inventory/classification engine remains to be implemented.
- [ ] Current execution can complete with low/no datapoint coverage in some scenarios; next phase must harden guardrails around compiled obligations, chunk availability, and diagnostics thresholds.
- [ ] NotebookLM MCP integration remains operationally sensitive to service-account/browser session drift; rollout should include staged canary checks before enabling persistence.

## Repository Conventions
- Branch naming: `pr-XXX-<short-name>`
- Commit message: `PR-XXX: <short summary>`
- Required checks: `make lint`, `make test`

## Notes
- This file is updated every PR:
  - Add PR to Completed Work (2–5 bullets)
  - Advance Next PR ID to the next PR in docs/PR_CONVEYOR_PLAN.md
  - Record any new blockers/risks

## Planned Workstream (Next)
- Next execution stream should start at `PR-NBLM-011`.
